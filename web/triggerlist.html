<!DOCTYPE html>
<html ng-app="triggerListApp">
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>XS市集 - 策略觸發記錄</title>
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.min.css">

    <!-- main angular modules -->
    <script src="bower_components/angular/angular.min.js"></script>
    <script src="bower_components/angular-route/angular-route.min.js"></script>
    <script src="bower_components/angular-sanitize/angular-sanitize.min.js"></script>
    <script src="bower_components/angular-animate/angular-animate.min.js"></script>

    <!-- for spinner -->
    <script src="bower_components/spin.js/spin.js"></script>
    <script src="bower_components/angular-spinner/angular-spinner.min.js"></script>

    <!-- for angular-strap -->
    <script src="bower_components/angular-strap/dist/angular-strap.min.js"></script>
    <script src="bower_components/angular-strap/dist/angular-strap.tpl.min.js"></script>

    <script src="bower_components/underscore/underscore-min.js"></script>
    <script src="bower_components/moment/min/moment.min.js"></script>

    <script src="js/env.js"></script>
    <script>
        var thisApp = angular.module('triggerListApp', ['angularSpinner', 'mgcrea.ngStrap', 'ngSanitize', 'ngRoute', 'envModule']);

        thisApp.config(function ($routeProvider, $locationProvider) {
            $locationProvider.html5Mode({
              enabled: true,
              requireBase: false
            });
        });

        thisApp.controller('TriggerListCtrl', ['$scope', '$http', '$location', 'usSpinnerService',
            function($scope, $http, $location, spinnerService) {

                $scope.data = {};
                $scope.error = null;

                $scope.guid = $location.search()['guid'] || '';
                if ($scope.guid == '') {
                    $scope.error = 'missing guid參數 !!';
                    return;
                }

                // TODO: strategy name 目前用傳的
                $scope.name = $location.search()['name'] || $scope.guid;

                // default range: 最近7日
                //
                $scope.dateEnd = new Date();
                $scope.dateStart = new Date();
                $scope.dateStart.setDate($scope.dateEnd.getDate()-7);

                $scope.data.records = [];

                $scope.execQuery = function() {
                    $scope.query();
                };

                $scope.startSpinner = function() {
                    spinnerService.spin('spinner');
                };

                $scope.stopSpinner = function() {
                    spinnerService.stop('spinner');
                };

                $scope.query = function() {
                    var url_triggerlist = "api/triggerlist?guid=" + $scope.guid + "&s=" + moment($scope.dateStart).format("YYYYMMDD") + "&e=" + moment($scope.dateEnd).format("YYYYMMDD");

                    $scope.startSpinner();
                    $scope.error = null;

                    $http.get(url_triggerlist)
                        .success(function(records) {
                            $scope.data.records = records;
                            $scope.error = null;
                        })
                        .error(function(error) {
                            $scope.error = error;
                        })
                        .finally(function() {
                            $scope.stopSpinner();
                        });
                };

                // Run the initial query
                //
                $scope.query();
            }]);
    </script>
</head>
<body ng-controller="TriggerListCtrl">
<env></env>
<div class="container">
    <div class="page-header">
        <h3>
            <ol class="breadcrumb">
                <li><a href="index.html" target="_self">Home</a></li>
                <li><a href="appsales.html" target="_self">策略紀錄</a></li>
                <li class="active">觸發記錄</li>
            </ol>
        </h3>
    </div>
    <div class="alert alert-danger" ng-show="error" ng-cloak>
        讀取資料時發生錯誤: ({{error}}).
    </div>

    <span us-spinner="{radius:30, width:10, length:0, line:10}" spinner-key="spinner"></span>

    <h3 ng-cloak>{{name}}</h3>

    <form name="queryForm" class="form-inline" style="padding-bottom: 10px;" novalidate>
        <div class="form-group" ng-class="{'has-error': queryForm.dateStart.$invalid}">
            <label for="dateStart">開始日期</label>
            <input type="text" autoclose="true" class="form-control" ng-model="dateStart" id="dateStart" name="dateStart" date-format="yyyy/MM/dd"  bs-datepicker>
        </div>

        <div class="form-group" ng-class="{'has-error': queryForm.dateEnd.$invalid}">
            <label for="dateEnd">結束日期</label>
            <input type="text" autoclose="true" class="form-control" ng-model="dateEnd" id="dateEnd" name="dateEnd" date-format="yyyy/MM/dd" bs-datepicker>
        </div>

        <div class="form-group">
            <button type="button" class="btn btn-primary" ng-click="execQuery()">查詢觸發記錄 <span class="glyphicon glyphicon-search"></span></button>
        </div>
    </form>

    <table class="table table-striped table-bordered table-hover" ng-hide="error" ng-cloak="true">
        <thead>
            <tr>
                <td class="text-center">日期</td>
                <td class="text-center">時間</td>
                <td class="text-center">商品代碼</td>
                <td class="text-center">觸發價位</td>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="record in data.records">
                <td class="text-center">{{record.date}}</td>
                <td class="text-center">{{record.time}}</td>
                <td class="text-center">{{record.symbol}}</td>
                <td class="text-center">{{record.price}}</td>
            </tr>
        </tbody>
    </table>
</div>
</body>
</html>